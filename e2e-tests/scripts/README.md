# E2E Test Scripts

This directory contains utility scripts for the MusicalConductor E2E test environment.

## Plugin Bundle Builder

### Overview

The `build-plugin-bundles.js` script automatically creates `dist/plugin.js` bundle files for all E2E test plugins. This eliminates 404 errors during plugin loading and ensures clean test logs.

## Plugin Bundle Watcher

### Overview

The `watch-plugin-bundles.js` script provides automatic rebuilding of plugin bundles during development. It watches all plugin source files and rebuilds bundles when changes are detected.

### Usage

```bash
# Start watching (rebuilds bundles automatically on file changes)
npm run watch:plugins

# Direct execution
node scripts/watch-plugin-bundles.js
```

### Features

- **Auto-rebuild**: Automatically rebuilds bundles when source files change
- **Debouncing**: Prevents excessive rebuilds from rapid file changes
- **Initial build**: Builds all bundles on startup
- **Graceful shutdown**: Clean exit with Ctrl+C
- **Multi-file watching**: Monitors all plugin source files simultaneously

### Usage

#### NPM Scripts (Recommended)

```bash
# Build only changed plugins (smart rebuild)
npm run build:plugins

# Force rebuild all plugins
npm run build:plugins:force

# Build with verbose output
npm run build:plugins:verbose
```

#### Direct Node.js Execution

```bash
# Basic usage
node scripts/build-plugin-bundles.js

# Force rebuild all bundles
node scripts/build-plugin-bundles.js --force

# Verbose output
node scripts/build-plugin-bundles.js --verbose

# Show help
node scripts/build-plugin-bundles.js --help
```

### How It Works

1. **Scans** the `test-app/plugins/` directory for plugin folders
2. **Checks** each plugin for an `index.js` source file
3. **Compares** timestamps to determine if rebuild is needed (unless `--force` is used)
4. **Creates** `dist/` directory if it doesn't exist
5. **Copies** `index.js` content to `dist/plugin.js` with a build header
6. **Reports** build summary with success/skip/error counts

### Features

- **Smart Rebuilds**: Only rebuilds bundles when source files have changed
- **Automatic Directory Creation**: Creates `dist/` directories as needed
- **Build Headers**: Adds timestamp and source information to bundles
- **Error Handling**: Graceful handling of missing files and permissions
- **Verbose Logging**: Optional detailed output for debugging
- **Force Mode**: Option to rebuild all bundles regardless of timestamps

### Bundle Structure

Each generated bundle includes:

```javascript
/**
 * Bundle for plugin-name
 * Generated automatically from index.js
 * Build time: 2025-08-08T00:47:11.623Z
 *
 * DO NOT EDIT THIS FILE DIRECTLY
 * Edit the source file: index.js
 * Then run: npm run build:plugins
 */

// Original plugin code from index.js
export const sequence = { ... };
export const handlers = { ... };
```

### Integration with Development Workflow

#### When to Run

- **After editing plugin source files** (`index.js`)
- **Before running E2E tests** (to ensure bundles are up to date)
- **During CI/CD builds** (to generate fresh bundles)

#### Recommended Workflow

**Manual Build Workflow:**

1. Edit plugin source file: `test-app/plugins/my-plugin/index.js`
2. Build bundles: `npm run build:plugins`
3. Run tests: `npm test`

**Development Workflow (with auto-rebuild):**

1. Start watcher: `npm run watch:plugins`
2. Edit plugin source files (bundles rebuild automatically)
3. Run tests in another terminal: `npm test`

#### Git Integration

Consider adding a pre-commit hook or CI step to ensure bundles are always up to date:

```bash
# In package.json scripts
"pretest": "npm run build:plugins"
```

### Troubleshooting

#### Common Issues

**Permission Errors**

- Ensure write permissions to plugin directories
- Check if files are locked by other processes

**Missing Source Files**

- Verify `index.js` exists in plugin directories
- Check file naming (case-sensitive on some systems)

**Build Failures**

- Run with `--verbose` flag for detailed error information
- Check Node.js version compatibility (requires Node.js 14+)

#### Debug Commands

```bash
# Check what would be built
npm run build:plugins:verbose

# Force rebuild with detailed output
npm run build:plugins:force -- --verbose

# Test script without building
node -e "console.log(require('./scripts/build-plugin-bundles.js'))"
```

### Script Configuration

The script can be customized by editing the configuration constants at the top of `build-plugin-bundles.js`:

```javascript
const PLUGINS_DIR = path.join(__dirname, "..", "test-app", "plugins");
const BUNDLE_FILENAME = "plugin.js";
const SOURCE_FILENAME = "index.js";
```
